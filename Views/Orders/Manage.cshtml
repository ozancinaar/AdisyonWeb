@model AdisyonWeb.ViewModels.OrderManageViewModel

@{
    ViewData["Title"] = "Masa Sipariþi";
}

<h2>Masa @Model.Table.TableNumber - Sipariþ</h2>

@if (TempData["Error"] != null)
{
<div class="alert alert-danger">
    @TempData["Error"]
</div>
}

<div class="row mt-3">
    <!-- SOL: SÝPARÝÞ ÖZETÝ -->
    <div class="col-md-6">
        <h4>Aktif Sipariþ (#@Model.Order.OrderId)</h4>

        @if (Model.OrderItems.Any())
        {
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Ürün</th>
                    <th style="width:120px;">Adet</th>
                    <th>Birim Fiyat</th>
                    <th>Toplam</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.OrderItems)
                {
                <tr>
                    <td>@item.MenuItem.Name</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <a asp-action="DecreaseItem"
                               asp-route-orderItemId="@item.OrderItemId"
                               class="btn btn-outline-secondary">-</a>
                            <span class="btn btn-light disabled">@item.Quantity</span>
                            <a asp-action="IncreaseItem"
                               asp-route-orderItemId="@item.OrderItemId"
                               class="btn btn-outline-secondary">+</a>
                        </div>
                    </td>
                    <td>@item.UnitPrice.ToString("0.00")</td>
                    <td>@(item.Quantity * item.UnitPrice).ToString("0.00")</td>
                    <td>
                        <a asp-action="RemoveItem"
                           asp-route-orderItemId="@item.OrderItemId"
                           class="btn btn-sm btn-danger">Sil</a>
                    </td>
                </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3" class="text-end">Toplam:</th>
                    <th>@Model.Order.TotalAmount.ToString("0.00")</th>
                    <th></th>
                </tr>
            </tfoot>
        </table>

        <a asp-action="Payment"
           asp-route-orderId="@Model.Order.OrderId"
           class="btn btn-success mt-2">
            Ödemeye Geç
        </a>
        }
        else
        {
        <p>Bu masada henüz ürün eklenmemiþ.</p>
        }
    </div>

    <!-- SAÐ: KATEGORÝLERE GÖRE AÇILIR MENÜ -->
    <div class="col-md-6">
        <h4>Menü</h4>

        @if (!Model.MenuItems.Any())
        {
        <p>Menüde ürün bulunmuyor.</p>
        }
        else
        {
            var grouped = Model.MenuItems
                .Where(m => m.IsActive)
                .OrderBy(m => m.Category.Name)
                .ThenBy(m => m.Name)
                .GroupBy(m => m.Category.Name);

        <div class="accordion" id="menuAccordion">
            @foreach (var group in grouped)
                {
                    var categoryName = group.Key;
                    var categoryId = categoryName.Replace(" ", "").Replace("ý","i").Replace("Ý","I"); // id için basit temizleme
                    var collapseId = $"collapse_{categoryId}";
                    var headingId = $"heading_{categoryId}";

            <div class="accordion-item">
                <h2 class="accordion-header" id="@headingId">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#@collapseId"
                            aria-expanded="false"
                            aria-controls="@collapseId">
                        @categoryName
                    </button>
                </h2>
                <div id="@collapseId"
                     class="accordion-collapse collapse"
                     aria-labelledby="@headingId"
                     data-bs-parent="#menuAccordion">
                    <div class="accordion-body p-0">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Ürün</th>
                                    <th>Açýklama</th>
                                    <th style="width:100px;">Fiyat</th>
                                    <th style="width:80px;">Stok</th>
                                    <th style="width:80px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var m in group)
                                    {
                                <tr>
                                    <td>@m.Name</td>
                                    <td>@m.Description</td>
                                    <td>@m.UnitPrice.ToString("0.00")</td>
                                    <td>@m.StockQuantity</td>
                                    <td>
                                        <form asp-action="AddItem" method="post" class="d-inline">
                                            <input type="hidden" name="orderId" value="@Model.Order.OrderId" />
                                            <input type="hidden" name="menuItemId" value="@m.MenuItemId" />
                                            <button type="submit"
                                                    class="btn btn-sm btn-primary"
                                                    @(m.StockQuantity <= 0 ? "disabled" : "")>
                                                Ekle
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                    }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
                }
        </div>
        }
    </div>
</div>
